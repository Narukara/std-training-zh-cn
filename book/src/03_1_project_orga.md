# é¡¹ç›®ç»“æ„

## esp-rs crates

ä¸åƒå¤§å¤šæ•°å…¶ä»–åµŒå…¥å¼å¹³å°ï¼ŒEspressif æ”¯æŒ Rust æ ‡å‡†åº“ã€‚å…¶ä¸­æœ€å€¼å¾—å…³æ³¨çš„æ˜¯ï¼Œä½ å¯ä»¥ä»»æ„ä½¿ç”¨å¤§å°å¯å˜çš„é›†åˆï¼Œä¾‹å¦‚ `Vec` æˆ– `HashMap`ï¼Œä»¥åŠåŸºäº `Box` çš„é€šç”¨å †å­˜å‚¨ã€‚ä½ è¿˜å¯ä»¥è‡ªç”±åœ°åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨ `Arc` å’Œ `Mutex` ç­‰åŒæ­¥åŸè¯­åœ¨å®ƒä»¬ä¹‹é—´å®‰å…¨åœ°å…±äº«æ•°æ®ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå†…å­˜åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸Šä»ç„¶æ˜¯ä¸€ç§ç¨€ç¼ºèµ„æºï¼Œå› æ­¤éœ€è¦æ³¨æ„ä¸è¦è€—å°½å®ƒâ€”â€”å°¤å…¶æ˜¯ï¼Œä½¿ç”¨çº¿ç¨‹çš„ä»£ä»·å¯èƒ½ä¼šå¾ˆé«˜ã€‚

Services like WiFi, HTTP client/server, MQTT, OTA updates, logging etc. are exposed via Espressif's open source IoT Development Framework, [esp-idf](https://github.com/espressif/esp-idf). It is mostly written in C and as such is exposed to Rust in the canonical split crate style: 
- a `sys` crate to provide the actual `unsafe` bindings ([esp-idf-sys](https://github.com/esp-rs/esp-idf-sys))
- a higher level crate offering safe and comfortable Rust abstractions ([esp-idf-svc](https://github.com/esp-rs/esp-idf-svc/))

The final piece of the puzzle is low-level hardware access, which is again provided in a split fashion:
- [esp-idf-hal](https://github.com/esp-rs/esp-idf-hal) implements the hardware-independent [embedded-hal](https://github.com/rust-embedded/embedded-hal) traits like analog/digital conversion, digital I/O pins, or SPI communication - as the name suggests, it also uses `esp-idf` as a foundation
- if direct register manipulation is required, [esp32c3](https://github.com/esp-rs/esp32c3) provides the peripheral access create generated by svd2rust.

More information is available in the [ecosystem chapter](https://esp-rs.github.io/book/overview/using-the-standard-library.html) of the `esp-rs` book.

### Build toolchain

ğŸ” As part of a project build, `esp-idf-sys` will download [esp-idf](https://github.com/espressif/esp-idf), the C-based Espressif toolchain. The download destination is configurable; to save disk space and download time, all examples/exercises in the workshop repository are set to use one single `global` toolchain, installed in `~/.espressif`. See the `ESP_IDF_TOOLS_INSTALL_DIR` parameter in `esp-idf-sys`'s [README](https://github.com/esp-rs/esp-idf-sys#configuration) for other options.

## Package layout

On top of the usual contents of a Rust project created with `cargo new`, a few additional files and parameters are required. The examples/exercises in this workshop are already fully configured, and for creating new projects it is recommended to use the [cargo-generate](./03_2_cargo_generate.md) wizard based approach.

ğŸ” The rest of this page is optional knowledge that can come in handy should you wish to change some aspects of a project.

### `Cargo.toml`

This workshop is written around the `native` build system. Alternatively you may use `PlatformIO`/`pio`, however this is currently being deprecated.

```toml
[features]
default = ["native"]
native = ["esp-idf-sys/native"]
```

Some build dependencies must be set:

```toml
[build-dependencies]
embuild = "0.28"
anyhow = "1"
```

### Additional configuration files

- `build.rs` - [Cargo build script](https://doc.rust-lang.org/cargo/reference/build-scripts.html). Here: sets environment variables required for building.
- `.cargo/config.toml` - sets the target architecture and controls build details. This is the place to override `ESP_IDF_TOOLS_INSTALL_DIR` if you wish to do so.
- `sdkconfig.defaults` - overrides `esp-idf` specific parameters such as stack size or log level.
