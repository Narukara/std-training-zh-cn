# é¡¹ç›®ç»“æ„

## esp-rs crates

ä¸åƒå¤§å¤šæ•°å…¶ä»–åµŒå…¥å¼å¹³å°ï¼ŒEspressif æ”¯æŒ Rust æ ‡å‡†åº“ã€‚å…¶ä¸­æœ€å€¼å¾—å…³æ³¨çš„æ˜¯ï¼Œä½ å¯ä»¥ä»»æ„ä½¿ç”¨å¤§å°å¯å˜çš„é›†åˆï¼Œä¾‹å¦‚ `Vec` æˆ– `HashMap`ï¼Œä»¥åŠåŸºäº `Box` çš„é€šç”¨å †å­˜å‚¨ã€‚ä½ è¿˜å¯ä»¥è‡ªç”±åœ°åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨ `Arc` å’Œ `Mutex` ç­‰åŒæ­¥åŸè¯­åœ¨å®ƒä»¬ä¹‹é—´å®‰å…¨åœ°å…±äº«æ•°æ®ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå†…å­˜åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸Šä»ç„¶æ˜¯ä¸€ç§ç¨€ç¼ºèµ„æºï¼Œå› æ­¤éœ€è¦æ³¨æ„ä¸è¦è€—å°½å®ƒâ€”â€”å°¤å…¶æ˜¯ï¼Œä½¿ç”¨çº¿ç¨‹çš„ä»£ä»·å¯èƒ½ä¼šå¾ˆé«˜ã€‚

Espressif çš„å¼€æºç‰©è”ç½‘å¼€å‘æ¡†æ¶ [esp-idf](https://github.com/espressif/esp-idf) æä¾›äº† WiFiã€HTTP å®¢æˆ·ç«¯/æœåŠ¡å™¨ã€MQTTã€OTA æ›´æ–°ã€æ—¥å¿—è®°å½•ç­‰æœåŠ¡ã€‚esp-idf ä¸»è¦æ˜¯ç”¨ C ç¼–å†™çš„ï¼Œå› æ­¤å°†å®ƒä»¥è§„èŒƒçš„ã€åˆ†ç¦»çš„ crate çš„å½¢å¼æä¾›ç»™ Rustï¼š

- ä¸€ä¸ª `sys` crate æä¾›äº†å®é™…çš„ `unsafe` bindingsï¼ˆ[esp-idf-sys](https://github.com/esp-rs/esp-idf-sys)ï¼‰
- ä¸€ä¸ªé«˜çº§çš„ crate æä¾›äº†å®‰å…¨æ˜“ç”¨çš„ Rust æŠ½è±¡ï¼ˆ[esp-idf-svc](https://github.com/esp-rs/esp-idf-svc/)ï¼‰

æœ€åä¸€éƒ¨åˆ†æ˜¯åº•å±‚ç¡¬ä»¶è®¿é—®ï¼Œä»ä»¥åˆ†ç¦»çš„å½¢å¼æä¾›ï¼š

- [esp-idf-hal](https://github.com/esp-rs/esp-idf-hal) å®ç°äº†ç¡¬ä»¶æ— å…³çš„ [embedded-hal](https://github.com/rust-embedded/embedded-hal) traitsï¼Œä¾‹å¦‚æ¨¡æ•°è½¬æ¢ã€æ•°å­— I/O å¼•è„šã€SPI é€šä¿¡ã€‚æ­£å¦‚å®ƒçš„åå­—æ‰€æš—ç¤ºçš„ï¼Œå®ƒä¾èµ–äº `esp-idf`ã€‚
- å¦‚æœéœ€è¦ç›´æ¥æ“ä½œå¯„å­˜å™¨ï¼Œ[esp32c3](https://github.com/esp-rs/esp32c3) æä¾›ç”± svd2rust ç”Ÿæˆçš„å¤–è®¾è®¿é—® crateã€‚

`esp-rs` book çš„ [ecosystem ç« èŠ‚](https://esp-rs.github.io/book/overview/using-the-standard-library.html) æä¾›äº†æ›´å¤šä¿¡æ¯ã€‚

### æ„å»ºå·¥å…·é“¾

ğŸ” ä½œä¸ºé¡¹ç›®æ„å»ºçš„ä¸€éƒ¨åˆ†ï¼Œ`esp-idf-sys` ä¼šä¸‹è½½åŸºäº C çš„ Espressif å·¥å…·é“¾ [esp-idf](https://github.com/espressif/esp-idf)ã€‚ä¸‹è½½ä½ç½®æ˜¯å¯é…ç½®çš„ï¼Œä¸ºäº†èŠ‚çœç¡¬ç›˜ç©ºé—´å’Œä¸‹è½½æ—¶é—´ï¼Œæœ¬è¯¾ç¨‹ä¸­çš„æ‰€æœ‰ç¤ºä¾‹å’Œç»ƒä¹ éƒ½è¢«è®¾ç½®ä¸ºä½¿ç”¨ä¸€ä¸ªå•ä¸€çš„`å…¨å±€`å·¥å…·é“¾ï¼Œå®‰è£…åœ¨ `~/.espressif` ä¸­ã€‚ å…³äºå…¶ä»–å¯é€‰çš„é…ç½®ï¼Œè¯·å‚é˜… `esp-idf-sys` çš„ [README](https://github.com/esp-rs/esp-idf-sys#configuration) ä¸­çš„ `ESP_IDF_TOOLS_INSTALL_DIR` å‚æ•°ã€‚

## Package å¸ƒå±€

ä¸ä½¿ç”¨ `cargo new` åˆ›å»ºçš„å¸¸è§„ Rust é¡¹ç›®ç›¸æ¯”ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„æ–‡ä»¶å’Œå‚æ•°ã€‚æœ¬è¯¾ç¨‹ä¸­çš„ç¤ºä¾‹å’Œç»ƒä¹ éƒ½å·²ç»é…ç½®å¥½ï¼Œè¦åˆ›å»ºæ–°é¡¹ç›®ï¼Œå»ºè®®ä½¿ç”¨åŸºäº [cargo-generate](./03_2_cargo_generate.md) å‘å¯¼çš„æ–¹æ³•ã€‚

ğŸ” æœ¬é¡µçš„å…¶ä½™éƒ¨åˆ†æ˜¯å¯é€‰çŸ¥è¯†ï¼Œåœ¨ä½ å¸Œæœ›æ›´æ”¹é¡¹ç›®çš„æŸäº›æ–¹é¢æ—¶å¯ä»¥æ´¾ä¸Šç”¨åœºã€‚

### `Cargo.toml`

æœ¬è¯¾ç¨‹æ˜¯å›´ç»• `native` æ„å»ºç³»ç»Ÿç¼–å†™çš„ã€‚å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨ `PlatformIO`/`pio`ï¼Œä½†ç›®å‰å·²å¼ƒç”¨ã€‚

```toml
[features]
default = ["native"]
native = ["esp-idf-sys/native"]
```

å¿…é¡»è®¾ç½®ä¸€äº›æ„å»ºä¾èµ–é¡¹ï¼š

```toml
[build-dependencies]
embuild = "0.28"
anyhow = "1"
```

### é¢å¤–çš„é…ç½®æ–‡ä»¶

- `build.rs` - [Cargo æ„å»ºè„šæœ¬](https://doc.rust-lang.org/cargo/reference/build-scripts.html)ã€‚è¿™é‡Œè®¾ç½®æ„å»ºæ‰€éœ€çš„ç¯å¢ƒå˜é‡ã€‚
- `.cargo/config.toml` - è®¾ç½®ç›®æ ‡æ¶æ„å¹¶æ§åˆ¶æ„å»ºç»†èŠ‚ã€‚å¦‚æœæœ‰éœ€è¦çš„è¯ï¼Œå¯ä»¥åœ¨æ­¤å¤„è¦†ç›– `ESP_IDF_TOOLS_INSTALL_DIR`ã€‚
- `sdkconfig.defaults` - è¦†ç›– `esp-idf` çš„ç‰¹å®šå‚æ•°ï¼Œä¾‹å¦‚å †æ ˆå¤§å°æˆ–æ—¥å¿—çº§åˆ«ã€‚
